<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>乐队排练投票</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; max-width: 800px; }
    h1 { margin-bottom: 6px; }
    .song-list { margin-bottom: 12px; }
    .song-list label { display: block; margin: 6px 0; cursor: pointer; }
    button { padding: 10px 16px; font-size: 16px; cursor: pointer; }
    table { border-collapse: collapse; width: 100%; margin-top: 16px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #f7f7f7; }
    tr.highlight { background: #d8f5d0; font-weight: 600; }
    .controls { display: flex; gap: 8px; align-items: center; margin-top: 8px; }
    .small { font-size: 13px; color: #666; }
    #usernameInput {
      font-size: 16px;
      padding: 6px 8px;
      width: 200px;
    }
    label[for="usernameInput"] {
      font-weight: bold;
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <h1>选择下一首排练歌曲</h1>
  <p class="small">多选可选任意多首。投票提交后会记录你本人的选择，每个人只计一次票数。页面会自动刷新结果。</p>

  <div class="controls" style="margin-bottom:12px; align-items:center;">
    <label for="usernameInput">用户名:</label>
    <input type="text" id="usernameInput" placeholder="请输入你的名字" autocomplete="off" />
  </div>

  <div class="song-list" id="songs">载入中...</div>

  <div class="controls">
    <button id="submitBtn">提交投票</button>
    <button id="selectAllBtn">全选</button>
    <button id="clearBtn">清除选择</button>
    <div style="margin-left:auto"><span id="lastUpdated" class="small"></span></div>
  </div>

  <h2>实时结果（按票数排序，前 5 名已高亮）</h2>
  <div id="results">载入中...</div>

  <script>
    const apiBase = "https://script.google.com/macros/s/AKfycbz3WBJlGv1jCTnps9mky0tTNAxYQ59Xo2RXnhZAn-ekxpq3HeqUneI-YdJS5pFi3lG_ZQ/exec"; // 换成你的 Apps Script 部署 URL

    // HTML转义
    function escapeHtml(text) {
      if (!text && text !== 0) return '';
      return String(text)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // 保存勾选状态到 localStorage
    function saveSelections() {
      const selectedSongs = Array.from(document.querySelectorAll('#songs input:checked')).map(i => i.value);
      localStorage.setItem('selectedSongs', JSON.stringify(selectedSongs));
    }

    // 恢复勾选状态
    function restoreSelections() {
      const saved = JSON.parse(localStorage.getItem('selectedSongs') || '[]');
      saved.forEach(value => {
        const checkbox = document.querySelector(`#songs input[value="${CSS.escape(value)}"]`);
        if (checkbox) checkbox.checked = true;
      });
    }

    // 渲染歌曲列表
    function renderSongList(data) {
      const container = document.getElementById('songs');
      container.innerHTML = '';
      for (let i = 1; i < data.length; i++) {
        const song = data[i][0];
        const id = 'song_' + i;
        const label = document.createElement('label');
        label.innerHTML = `<input id="${id}" type="checkbox" value="${escapeHtml(song)}"> ${escapeHtml(song)}`;
        container.appendChild(label);
      }
      restoreSelections();
      document.querySelectorAll('#songs input[type=checkbox]').forEach(cb => {
        cb.addEventListener('change', saveSelections);
      });
    }

    // 渲染投票结果
    function renderResults(data) {
      let songsData = data.slice(1).map(r => [r[0], Number(r[1] || 0)]);
      songsData.sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0]));
      let html = '<table><tr><th>排名</th><th>歌曲</th><th>票数</th></tr>';
      for (let i = 0; i < songsData.length; i++) {
        const row = songsData[i];
        const rank = i + 1;
        const cls = i < 5 ? ' class="highlight"' : '';
        html += `<tr${cls}><td>${rank}</td><td>${escapeHtml(row[0])}</td><td>${row[1]}</td></tr>`;
      }
      html += '</table>';
      document.getElementById('results').innerHTML = html;
    }

    // 用 JSONP 加载数据
    function loadSongs() {
      const script = document.createElement('script');
      script.src = apiBase + '?callback=handleData&t=' + Date.now();
      document.body.appendChild(script);
      // 为避免多次插入，加载完后自动移除脚本标签
      script.onload = () => {
        script.remove();
      };
    }

    // JSONP 回调
    function handleData(data) {
      if(data.error){
        document.getElementById('songs').innerText = '错误：' + data.error;
        document.getElementById('results').innerText = '';
        return;
      }
      renderSongList(data);
      renderResults(data);
      document.getElementById('lastUpdated').innerText = '最后更新：' + new Date().toLocaleString();
    }

    // 提交投票，使用 application/x-www-form-urlencoded POST
    async function submitVote() {
      const user = document.getElementById('usernameInput').value.trim();
      if (!user) {
        alert('请输入用户名');
        return;
      }
      const checked = Array.from(document.querySelectorAll('#songs input:checked')).map(i => i.value);
      if (checked.length === 0) {
        alert('请至少选择一首歌曲再提交');
        return;
      }

      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.innerText = '提交中...';

      try {
        const body = new URLSearchParams();
        body.append('user', user);
        body.append('songs', JSON.stringify(checked));

        const res = await fetch(apiBase, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: body.toString()
        });
        if (!res.ok) throw new Error('提交失败');
        const text = await res.text();
        alert('投票成功！');
        saveSelections();
        loadSongs();
      } catch (err) {
        alert('提交失败: ' + err.message);
        console.error(err);
      } finally {
        btn.disabled = false;
        btn.innerText = '提交投票';
      }
    }

    // 全选、清除
    function selectAll() {
      document.querySelectorAll('#songs input').forEach(i => i.checked = true);
      saveSelections();
    }
    function clearAll() {
      document.querySelectorAll('#songs input').forEach(i => i.checked = false);
      saveSelections();
    }

    document.getElementById('submitBtn').addEventListener('click', submitVote);
    document.getElementById('selectAllBtn').addEventListener('click', selectAll);
    document.getElementById('clearBtn').addEventListener('click', clearAll);

    // 首次加载
    loadSongs();
    // 10秒刷新一次
    //setInterval(loadSongs, 10000);
  </script>
</body>
</html>
